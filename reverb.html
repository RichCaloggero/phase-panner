<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta charset="utf-8">
<title>reverb</title>
<style>
label {display: block;}
</style>
</head>

<body>
<h1>reverb test</h1>

<div id="controls">
<div id="audio">
<h2>Audio</h2>
<label>audio: <input type="text" id="media" accesskey="f"></label>
<button id="load" accesskey="l">Load</button>
<audio tabindex="0"  accesskey="a" controls></audio>
</div>

<div id="parameters">
<label>Parameter: <select id="parameterList" accesskey="p"></select></label>
<label>value: <span class="value"></span>
<label>automation frequency: <input id="automationFrequency" type="range" value="1" min="0" max="100" step="0.1"></label>
<label>automation shape: <select id="automationShape"></select></label>
</div><!-- #parameters -->
</div><!-- #controls -->

<div id="message" aria-live="polite"></div>

<script src="resonance-audio.min.js"></script>
<script src="ui.js"></script>
<script src="component.js"></script>
<script src="reverb.js"></script>
<script src="parameters.js"></script>
<script src="parameterData.js"></script>
<script>
const messageDisplayTime = 20; // seconds
const audio = new AudioContext();
const audioElement = document.querySelector("audio");
const player = audio.createMediaElementSource (audioElement);
const scene = Reverb.createScene();
const reverb = new Reverb(audio, scene);
const room = Reverb.defaultRoom();
reverb.updateRoom(room);
reverb.setPosition(
[-99,0,0],
[99,0,0]
); // initial position

/// connections
player.connect(reverb.input);
reverb.output.connect(audio.destination);


/// initialize

const parameters = createParameterMap(parameterData);
console.log(`created ${parameters.size} parameters`);
populateSelector (
ui("parameterList"),
Array.from(parameters.keys()).filter(key => {
const parameter = parameters.get(key);
return (parameter.list && parameter.updater);
}) // filter
); // populateSelector

populateSelector(ui("automationShape"), "sine, square, sawtooth, triangle".split(", "));

/// events

ui("controls").addEventListener("change", e => update(e.target.value, e.target, e));

ui("controls").addEventListener("keydown", (e) => {
if (e.key === "0" && e.target.type && e.target.type === "range") {
e.target.value = 0;
signal(e.target);
e.target.focus();

} else if (e.key === "Enter" && e.target.type === "text") {
signal(e.target);
} // if
}); // special keys


/// updating

function update (value, element, e) {
console.log(`update: ${value}`);
try {
value = value.trim();
if (element.type === "range" || element.type === "number") {
value = Number(value);
} else if (value.startsWith("[") || value.startsWith("{")) {
value = JSON.parse(value);
} // if	

_update(value, element); // _update
} catch (e) {
message(e);
} // try


function _update (value, element) {
let parameter = parameters.get(element.id);
if (!parameter || parameter.list) parameter = parameters.get(getParameterName());
parameter.value = value;
parameter.selectedIndex = element.selectedIndex;
if (parameter && parameter.updater) {
run(parameter.updater, value);
} // if

function run(updater, value) {
if (!updater) return;
try {
if (updater instanceof Function) {
updater (value);
} else if (typeof(updater) === "object" && !(updater instanceof Array)) {

// special cases
if ("value" in updater) updater.value = value;
else if (element.id in updater) updater[element.id] = value;
else throw new Error(`cannot update: ${parameter.name} to ${value} with ${updater}`);

} else if (updater instanceof Array) {
updater.forEach(updater => run(updater, value));
} // if

} catch (e) {
console.log(`update: ${e}\n
${e.stack}\n
`);

} // try

} // run
} // _update
} // update

function displayParameter (parameter) {
console.log(`displaying ${parameter.name}...`);
const element = createUiControl(parameter);
applyConstraints(element, parameter);
const container = document.querySelector("#parameters .value");
container.innerHTML = "";
container.appendChild(element);
} // displayParameter

function applyConstraints (element, parameter) {

} // applyConstraints

function getParameterName () {
return ui("parameterList").value;
} // getParameterName

function message (...args) {
_message(args.join(", "));

function _message (text) {
const container = document.querySelector("#message");
container.textContent = text;
setTimeout(() => container.textContent = "", 1000 * messageDisplayTime);
return text;
} // _message
} // message

</script>

</body>
</html>
